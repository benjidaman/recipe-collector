<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat's Kitchen - Grocery List</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .grocery-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .grocery-item input[type="checkbox"] {
            margin-right: 10px;
        }
        .grocery-item.strikethrough {
            text-decoration: line-through;
            color: gray;
        }
    </style>
</head>
<body>
    <header>
        <img src="cat-kitchen-logo.png" alt="Cat's Kitchen Logo">
        <h1>Cat's Kitchen</h1>
    </header>
    <nav>
        <button onclick="window.location.href='index.html'">Add Recipe</button>
        <button onclick="window.location.href='recipes.html'">View Recipes</button>
        <button onclick="window.location.href='this-weeks-meals.html'">This Week's Meals</button>
        <button onclick="window.location.href='grocery-list.html'">Grocery List</button>
    </nav>
    <main>
        <h2>Grocery List</h2>
        <button onclick="deleteSelectedItems()" style="background-color: purple; color: white; padding: 10px; margin-bottom: 10px;">Delete Selected</button>
        <div id="grocery-list"></div>
        <div id="error" style="display: none; color: red;"></div>
    </main>
    <script>
        const API_BASE_URL = 'https://recipe-collector-functions.azurewebsites.net';

        async function loadGroceryList() {
            const groceryListDiv = document.getElementById('grocery-list');
            const errorElement = document.getElementById('error');

            try {
                const response = await fetch(`${API_BASE_URL}/api/getGroceryList`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const items = await response.json();
                    groceryListDiv.innerHTML = items.map(item => `
                        <div class="grocery-item ${item.isGrabbed ? 'strikethrough' : ''}" data-id="${item.id}">
                            <input type="checkbox" class="select-item" onchange="toggleSelection('${item.id}')">
                            <span>${item.name}</span>
                            <button onclick="toggleGrabbed('${item.id}', ${!item.isGrabbed})" style="margin-left: 10px;">
                                ${item.isGrabbed ? 'Unmark' : 'Mark as Grabbed'}
                            </button>
                        </div>
                    `).join('');
                } else {
                    const errorText = await response.text();
                    errorElement.textContent = `Error fetching grocery list: ${response.status} - ${errorText}`;
                    errorElement.style.display = 'block';
                }
            } catch (error) {
                errorElement.textContent = `Error: ${error.message}`;
                errorElement.style.display = 'block';
            }
        }

        function toggleSelection(itemId) {
            const itemDiv = document.querySelector(`.grocery-item[data-id="${itemId}"]`);
            itemDiv.classList.toggle('selected');
        }

        async function toggleGrabbed(itemId, isGrabbed) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/updateGroceryItem`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: itemId, isGrabbed })
                });

                if (response.ok) {
                    loadGroceryList();
                } else {
                    const errorText = await response.text();
                    alert(`Error updating item: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function deleteSelectedItems() {
            const selectedItems = document.querySelectorAll('.select-item:checked');
            const itemIds = Array.from(selectedItems).map(item => item.parentElement.getAttribute('data-id'));

            if (itemIds.length === 0) {
                alert('Please select at least one item to delete.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/deleteGroceryItems`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemIds })
                });

                if (response.ok) {
                    loadGroceryList();
                } else {
                    const errorText = await response.text();
                    alert(`Error deleting items: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        window.onload = loadGroceryList;
    </script>
</body>
</html>