<!-- recipes.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recipes - Recipe Collector</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .recipe { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
        .error { color: red; }
        .success { color: green; }
        .message { display: none; }
        .ingredient-form { margin-top: 10px; }
        .filters { margin-bottom: 20px; }
    </style>
</head>
<body>
    <h1>Recipes</h1>
    <div class="filters">
        <label><input type="checkbox" id="filter-chicken"> Chicken</label>
        <label><input type="checkbox" id="filter-beef"> Beef</label>
        <label><input type="checkbox" id="filter-vegetarian"> Vegetarian</label>
    </div>
    <div id="recipes"></div>
    <p id="error" class="error" style="display: none;"></p>
    <a href="/index.html">Back to Add Recipe</a>

    <script>
        const API_BASE_URL = ''; // For deployed app (relative URL)
        let allRecipes = []; // Store all recipes for filtering

        async function loadRecipes() {
            const recipesDiv = document.getElementById('recipes');
            const errorElement = document.getElementById('error');

            try {
                const response = await fetch(`${API_BASE_URL}/api/getRecipes`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const contentType = response.headers.get('Content-Type');
                    if (contentType && contentType.includes('application/json')) {
                        allRecipes = await response.json();
                        displayRecipes();
                    } else {
                        throw new Error('Response is not JSON');
                    }
                } else {
                    const errorText = await response.text();
                    errorElement.textContent = `Error fetching recipes: ${response.status} - ${errorText}`;
                    errorElement.style.display = 'block';
                }
            } catch (error) {
                errorElement.textContent = `Error: ${error.message}`;
                errorElement.style.display = 'block';
            }
        }

        function displayRecipes() {
            const recipesDiv = document.getElementById('recipes');
            const filterChicken = document.getElementById('filter-chicken').checked;
            const filterBeef = document.getElementById('filter-beef').checked;
            const filterVegetarian = document.getElementById('filter-vegetarian').checked;

            let filteredRecipes = allRecipes;

            if (filterChicken || filterBeef || filterVegetarian) {
                filteredRecipes = allRecipes.filter(recipe => {
                    const name = recipe.name.toLowerCase();
                    return (filterChicken && name.includes('chicken')) ||
                           (filterBeef && name.includes('beef')) ||
                           (filterVegetarian && name.includes('vegetarian'));
                });
            }

            if (filteredRecipes.length === 0) {
                recipesDiv.innerHTML = '<p>No recipes found.</p>';
            } else {
                recipesDiv.innerHTML = filteredRecipes.map(recipe => `
                    <div class="recipe">
                        <h3>${recipe.name} (ID: ${recipe.id})</h3>
                        <p><a href="${recipe.url}" target="_blank">${recipe.url}</a></p>
                        <p>Ingredients: ${recipe.ingredients.length > 0 ? recipe.ingredients.join(', ') : 'None'}</p>
                        <div class="ingredient-form">
                            <input type="text" id="ingredients-${recipe.id}" placeholder="Enter ingredients (comma-separated)">
                            <button onclick="addIngredients('${recipe.id}')">Add Ingredients</button>
                        </div>
                        <button onclick="deleteRecipe('${recipe.id}')">Delete</button>
                        <div id="message-${recipe.id}" class="message"></div>
                    </div>
                `).join('');
            }
        }

        async function deleteRecipe(recipeId) {
            const messageElement = document.getElementById(`message-${recipeId}`);

            // Clear previous message
            messageElement.textContent = '';
            messageElement.style.display = 'none';
            messageElement.classList.remove('success', 'error');

            try {
                const response = await fetch(`${API_BASE_URL}/api/deleteRecipe/${recipeId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    messageElement.textContent = 'Recipe deleted successfully!';
                    messageElement.classList.add('success');
                    messageElement.style.display = 'block';
                    setTimeout(() => {
                        messageElement.style.display = 'none';
                    }, 2000);
                    loadRecipes();
                } else {
                    const errorText = await response.text();
                    messageElement.textContent = `Error deleting recipe: ${response.status} - ${errorText}`;
                    messageElement.classList.add('error');
                    messageElement.style.display = 'block';
                }
            } catch (error) {
                messageElement.textContent = `Error: ${error.message}`;
                messageElement.classList.add('error');
                messageElement.style.display = 'block';
            }
        }

        async function addIngredients(recipeId) {
            const ingredientsInput = document.getElementById(`ingredients-${recipeId}`).value;
            const messageElement = document.getElementById(`message-${recipeId}`);
            const ingredients = ingredientsInput.split(',').map(item => item.trim()).filter(item => item);

            // Clear previous message
            messageElement.textContent = '';
            messageElement.style.display = 'none';
            messageElement.classList.remove('success', 'error');

            if (ingredients.length === 0) {
                messageElement.textContent = 'Please enter at least one ingredient.';
                messageElement.classList.add('error');
                messageElement.style.display = 'block';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/addIngredients/${recipeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingredients })
                });

                if (response.ok) {
                    messageElement.textContent = 'Ingredients added successfully!';
                    messageElement.classList.add('success');
                    messageElement.style.display = 'block';
                    setTimeout(() => {
                        messageElement.style.display = 'none';
                    }, 2000);
                    document.getElementById(`ingredients-${recipeId}`).value = '';
                    loadRecipes();
                } else {
                    const errorText = await response.text();
                    messageElement.textContent = `Error adding ingredients: ${response.status} - ${errorText}`;
                    messageElement.classList.add('error');
                    messageElement.style.display = 'block';
                }
            } catch (error) {
                messageElement.textContent = `Error: ${error.message}`;
                messageElement.classList.add('error');
                messageElement.style.display = 'block';
            }
        }

        // Add event listeners for filter checkboxes
        document.getElementById('filter-chicken').addEventListener('change', displayRecipes);
        document.getElementById('filter-beef').addEventListener('change', displayRecipes);
        document.getElementById('filter-vegetarian').addEventListener('change', displayRecipes);

        window.onload = loadRecipes;
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9281cb6a4be2ed7f',t:'MTc0MzI3Njc2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>